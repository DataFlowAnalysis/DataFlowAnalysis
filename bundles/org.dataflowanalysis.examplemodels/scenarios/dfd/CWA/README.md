  # üìä Diagram: Corona Warn App (CWA)

## üîó Link to Original Paper/Article
[View Full Main Source](<https://github.com/corona-warn-app/cwa-documentation/blob/main/solution_architecture.md>)

## üìù Short Description
This diagram illustrates the complex data flow of the Corona-Warn-App (CWA), as stated in their documentation. The architecture is divided into three main components: **Corona-Warn-App**, **Verification Server** and **Corona-Warn-App Server**. The first one runs on the user's mobile phone. This component is responsible for scanning nearby users' keys via *Bluetooth Low Energy (BLE)*, interacting with the *Exposure Notification Framework*, and communicating with the *Data Donation Server*. The second one verifies test results received from the *Test Result Server*. The last one receives diagnosis keys from the CWA and analytics data from the *Data Donation Server*. It stores this data and, via the *Content Delivery Network (CDN)*, makes it available to other users, allowing them to determine whether they have been in contact with someone who tested positive.

## üî§ Abbreviations
- TEK: Temporary Exposure Key
- RPI: Rolling Proximity Identifier
- AEM: Associated Encrypted Metadata
- TAN: Transaction Authorization Number
- RAT: Rapid Antigen Test
- EDUS: Event-Driven User Survey Service
- PPA: Privacy-Preserving Analytics
- OTC: Open Telekom Cloud
- BLE: Bluetooth Low Energy

## üìñ Extensive Description (if possible)
The diagram can be divided into different sections. The first one, in the upper-right part of the diagram, is related to the __CWA Data Donation Server Interface__, in which depending on the users mobile phone OS a certain data flow is followed. For example in the case of an Android OS, the __Google Service__ node generates an *attestation_token* which flows to the __Google Attestation API__. From this node the *attestation_token* is forwarded to the __Send Attestation Token__ node which sends the token to the __Send PPA__ and __Send OTP for EDUS__, which are the two framewroks for collecting data. In addition to the *attestation_token* these nodes also receive *salt* from the __Generate Salt__ node (and forwarded by __Send Salt__ node) which is added to the token for security reasons. In the case of Apples OS the main idea is simmilar but with other nodes and functions. From the PPA and EDUS nodes the *ppa* data and the respective EDUS tokens finally flow to the __CWA Data Donation Server Interface__. From this point on, again depending on the OS, there is some verification/checking of the sent tokens, but most importantly the connection to the __Corona Warn App Server__. This connection is done through the __Analytic Data Storage__ which receives the *analytic_data* from the __CWA Data Donation Server Interface__ and forwards it to the __Generate Statistics__ node, which itself forwards this data to the C__Corona Warn App Server__.

The central (including left) part of the diagram focuses on the main data flows for the main tasks of CWA belonging to the test results functionality, creating/receiving the different identifiers for the user regarding their status. Here the most important nodes are the __Test Result Server__, which is responsible for receiving and transmitting the results from the __Laboratory Information System__ and forwarding them to the __Verification Server__. This server receives the pcr test results, RAT test results which can be directly uploaded by the user and the TAN identifier and forwards them to the __Corona Warn App__ (the test results) and the __Health Authority Portal__ (the teleTAN) and the __Upload Keys__ (normal TAN) nodes. The __Corona Warn App__ is mainly responsible for sending th ekeys which reflect the users state, evaluating the risk of the user given his/her encounter with other (possibly infected) users.

Finally the right-most side of the diagram shows the process of the distribution of the keys generated by the user thorugh the __Exposure Notification Framework__, which is the joint API/framework by Google and Apple that all national apps are built on. This node is responsible for: Receiving the RPIs via the __BLE Interface__ and sending the identifier through the __Send Bluetooth Payload__. Logging the foreign RPIs, their storage in __Foreign RPIs Storage__ node and their later comparison in the __Compare Keys__ node to create a risk summary for the user.

A further and deeper understanding of the different components can be studied in their documentation (link above).

## üè∑Ô∏è Label description

- ### üóÇÔ∏è Data Labels:
    - ### Identifiers:
        - __GuidQR__: QR for the test results
        - __PersonalData__: Personal data from the tested patient
        - __CWATestId__: Test ID from the Corona Warn App
        - __RPI__: A short-lived identifier derived from the TEK (changes every ~10‚Äì20 minutes). These are what phones actually broadcast via Bluetooth.
        - __TEK__: A secret key generated once per day on your phone. It never leaves your device except when you report a positive test.
        - __AEM__: Extra information sent together with the RPI over Bluetooth

    - ### Tokens:
        - __RegistrationToken__:  Registration for the app
        - __TAN__: A one-time code you get (e.g., via hotline or test result portal) that authorizes your app to upload your TEKs if you tested positive.
        - __DiagnosisKeys__: These are simply the TEKs from the days you were infectious that you upload
        - __TeleTAN__: A TAN given verbally by phone (via hotline) when your test result cannot automatically trigger a normal TAN
        - __DiagnosisKeyBatch__: Batch of Diagnosis Keys
        - __AttestationToken__: A cryptographic proof issued by the Google/Apple Exposure Notification (GAEN) framework.
        - __APIToken__: In Corona-Warn-App, this is a temporary token from the CWA server that the app uses to prove it already passed the TAN validation step.
        - __OTP__: A short-lived code used once in the verification process (e.g., during TAN/TeleTAN exchange). It prevents replay attacks when requesting tokens.
        - __DeviceToken__: A persistent identifier assigned per device to prevent abuse of the verification system (e.g., requesting too many TANs).
        - __Salt__: A random value added when hashing data (e.g., during device token creation) to ensure uniqueness and resist pre-computation attacks
    
    - ### TestResults:
        - __PCRTestResultsPositive__: PCR positive test results
        - __RATTestResults__: Results of the RAT test
    
    - ### UserConfigurations:
        - __NotificationsOn__: User allows to receive notifications from the app
        - __AllowUploadKeys__: User allows the app to upload its keys
        - __AllowPersonalData__: user allows the app to use its personal data
    
    - ### Encrypted:
        - __Metadata__: Metadata sent from the app

    - ### Information:
        - __RiskSummary__: Summary of potential risk for the user based on the received keys from other users
        - __APIsMetadata__: Metadata from the APIs
        - __EDUS__: Token for EDUS (backend-service for collecting data surveys from users)
        - __PPA__: Same as previous but for PPA (for collecting app usage statistics in a privacy-preserving way)
        - __AnalyticData__: Analytic data from the users to generate statistics
        - __SurveyData__: Data from the survey of the users
    
    - ### DiagnosisKeys:
        - __Local__: Diagnosis Keys from within germany
        - __Foreign__: Diagnosis Keys from other countries (normally within the UE)

- ### üè∑Ô∏è Node Labels:
    - ### MobileOS:
        - __IOS__: Apple Operating System
        - __Android__: Androids Operating System

    - ### Server:
        - __CWApp__: Corona Warn App in the users mobile phone
        - __CWAppServer__: Corona Warn App central servers
        - __VerificationServer__: Server where the test results are verified
        - __DDServer__: Diagnosis Data Server
        - __AppleServer__: Server from Apple for managing their API
        - __Androiderver__: Server from Android for managing their API
        - __TestResultServer__: Server for managing the test results coming from the laboratory
        - __ForeignCountryServer__: Server for the Covid app from a foreign country
        - __SurveyBrowser__: Browser where the survey takes place
        - __SurverySystemEDUS__: Survey System for the EDUS
        - __GoogleServer__: Googles server for the Attestation API
    - ### Cloud:
        -__OTC__: Hosting environment in the cloud for the CWApp backend

## ‚ö†Ô∏è Constraints
- RPI and TEK identifiers may never flow to the CWA or CWA Server for privacy reasons:

    1. __RPIs_TEKs__: `data Identifiers.RPI,Identifiers.TEK neverFlows vertex Server.CWApp,Server.CWAppServer`

- Personal data shuld never flow to the CWA (in the mobile phone), Verification server, Test Results Server, DD server and CWA server.

    2. __Personal_Data__: `data Identifiers.PersonalData neverFlows vertex Server.CWApp,Server.VerificationServer,Server.TestResultServer,Server.DDServer,Server.CWAppServer`

## üö® Violations
Although no violations were found in the original CWA architecture, we have slightly modified the diagram to produce two alternate versions in which violations are introduced:

- The first diagram, **RPIViolation**, illustrates a breach in which **RPIs (Rolling Proximity Identifiers)** flow into the CWA Server. This is a clear violation, as RPIs could potentially be linked back to individuals, undermining the anonymity and privacy principles of the original CWA.

  1. `data Identifiers.RPI neverFlows vertex Server.CWAppServer`

- The second diagram, **PersonalDataViolation**, shows a case where **personal data** from the user's mobile device flows into the CWA (via the Verification Server). This is another violation of the strict privacy guarantees provided by the real CWA.

  2. `data Identifiers.PersonalData neverFlows vertex Server.CWApp,Server.VerificationServer,Server.TestResultServer,Server.DDServer,Server.CWAppServer`













